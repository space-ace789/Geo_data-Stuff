---
title: "Geodata Assignment"
format: 
  html:
   toc: true
   toc-depth: 2
   toc-title: Contents
theme: minty
editor: visual
---

## Introduction

The two species I have chosen to look at are the Fisher (*Pekania pennanti*) and the North American Porcupine (*Erethizon dorsatum*). Fishers and Porcupines have a predator-prey relationship, therefore I expect their ranges to have limited overlap.

## Set Up

#### Packages used:

```{r Packages Used}
#| output: false
library(here)
library(dismo)
library(rworldmap)
library(sf)
library(geodata)
library(tibble)
library(terra)
```

#### Load in a World Map:

```{r Creating World Map object}
world_map <- getMap(resolution = "coarse")
```

#### Creating Species Coordinate Datasets:

```{r Creating a file structure}
#| include: false
sapply(c("data/raw", "data/processed"), function(dir) {
    dir_path <- here(dir)
    if (!dir.exists(dir_path)) dir.create(dir_path, recursive = TRUE)
})
#This code creates a file structure to allow the datasets created in this project to be stored in an organised fashion that makes them easy to find in the future.
```

To create the datasets first the the species data is downloaded from GBIF. This includes a lot of information not required for species distribution modelling. Therefore only the latitude and longitude data is extracted from the large dataset using the coordinate extraction function (see below). Species data was taken from GBIF data network, <https://www.gbif.org/>.

```{r Coordinate Extraction Function}
#| code-fold: true
#| code-summary: "Coordinate extration function"
#This code extracts just the longitude and latitude (coordinate data) values from the GBIF data
extract_coordinates <- function(speciesdata.gbif) {
    cbind(speciesdata.gbif$lon, speciesdata.gbif$lat) %>% #Combines the long atnd lat data to create coordinates
    na.omit() %>%  
    data.frame() #converts the list into a dataframe object
}
```

```{r Species 1 coordinate data}
#| echo: false
#Downloading data from GBIF
species1.gbif_file <- here("data", "raw", "species1.gbif.rds")
if (!file.exists(species1.gbif_file)) {
    species1.gbif <- gbif("pekania", "pennanti", geo = TRUE) #Insert the genus and species name of your chosen species in this line. 
    saveRDS(species1.gbif, species1.gbif_file)
} else {
    species1.gbif <- readRDS(species1.gbif_file)
}

#Creating dataframe of coordinates
species1_coords <- extract_coordinates(species1.gbif)
colnames(species1_coords) <- c("lon", "lat")
```

```{r Species 2 coordinate data}
#| echo: false
#Repeating dataset creation for the second species using the same code as above.
species2.gbif_file <- here("data", "raw", "species2.gbif.rds")
if (!file.exists(species2.gbif_file)) {
    species2.gbif <- gbif("erethizon", "dorsatus", geo = TRUE) 
    #The data for this species is held under the old scientific name Erethizon dorsatUS.
    saveRDS(species2.gbif, species2.gbif_file)
} else {
    species2.gbif <- readRDS(species2.gbif_file)
}

species2_coords <- extract_coordinates(species2.gbif)
colnames(species2_coords) <- c("lon", "lat")

#species1.gbif and species2.gbif (coordinate data) can be found stored within the raw folder which is within the data folder, as created in chunk 3: Creating file structure.

```

To ensure only coordinates within continental landmasses were included any points that intersected with a map of ocean coordinates were removed. The ocean coordinates were taken from the natural earth dataset, <https://naturalearth.s3.amazonaws.com/110m_physical/ne_110m_ocean.zip>.

```{r Downloading and Reading in Ocean Data}
#| echo: false

#Downloading Ocean data
ocean_data_dir <- here("data", "raw", "ocean")
if (!dir.exists(ocean_data_dir)) dir.create(ocean_data_dir)
URL <- "https://naturalearth.s3.amazonaws.com/110m_physical/ne_110m_ocean.zip"
zip_file <- file.path(ocean_data_dir, basename(URL))
if (!file.exists(zip_file)) {
    download.file(URL, zip_file)
}

files <- unzip(zip_file, exdir = ocean_data_dir) #unzips ocean datafile
oceans <- read_sf(grep("shp$", files, value = TRUE)) #Reads shape file

#The folder containing ocean data coordinates can be found within the raw folder within the data folder, as defined by the file structure created in chunk 3: creating a file structure.
```

```{r Species 1 remove ocean points}
#| echo: false
#| output: false

#Aligning species coordinates with ocean coordinate reference system.
species1_coords <- st_as_sf(species1_coords, coords = c("lon", "lat"))
st_crs(species1_coords) <- st_crs(oceans)
sf_use_s2(FALSE)  # Disables spherical geometry


# Find where out points intersect with the ocean
species1_intersect <- sapply(st_intersects(species1_coords, oceans), function(z) if (length(z) == 0) NA_integer_ else z[1])

if (sum(!is.na(species1_intersect)) > 0) {
    species1_coords <- data.frame(st_coordinates(species1_coords[is.na(species1_intersect), ]))
} else {
    species1_coords <- data.frame(st_coordinates(species1_coords))
}
colnames(species1_coords) <- c("lon", "lat")
```

```{r Species 2 remove ocean points}
#| echo: false
#| output: false

#Aligning species coordinates with ocean coordinate reference system.
species2_coords <- st_as_sf(species2_coords, coords = c("lon", "lat"))
st_crs(species2_coords) <- st_crs(oceans)
sf_use_s2(FALSE)

# Find where out points intersect with the ocean
species2_intersect <- sapply(st_intersects(species2_coords, oceans), function(z) if (length(z) == 0) NA_integer_ else z[1])

#Remove intersect points
if (sum(!is.na(species2_intersect)) > 0) {
    species2_coords <- data.frame(st_coordinates(species2_coords[is.na(species2_intersect), ]))
} else {
    species2_coords <- data.frame(st_coordinates(species2_coords))
}
colnames(species2_coords) <- c("lon", "lat")
```

```{r Removing anomalous points}
#| echo: false

#DO NOT RUN THIS CODE IF USING DIFFERENT SPECIES

#On visualisation of the final coordinate data for Fishers and Porcupine it became that there were a few potentially anomalous points. Both species are found exclusively in North America however between both species a small number of sightings were reported in Europe, Africa, Asia and South America. All of these points are very large outliers in their respective species data sets therefore they were removed from the dataset. 

species1_coords <- subset(species1_coords, lon < 0) #Removes any points which are in the Eastern Hemisphere, Fishers are not found here.

species2_coords <- subset(species2_coords, lon < 0) #Removes any points in the Eastern Hemisphere, North American Porcupine is not found here.
species2_coords <- subset(species2_coords, lat > 0) #Removes any points in the Southern Hemisphere, North American Porcupine is not found here. 

```

#### Loading and Extracting Climate Variables:

To create a model predicting species distribution based on climate variables you also need a dataset of various climate measurements from the area covered by the species dataset coordinates. Climate data was downloaded from the worldclim database, <https://www.worldclim.org/>.

```{r Downloading climate data}
#| echo: false
bio_data <- worldclim_global(var = "bio", res = 10, path = here("data", "raw"))
names(bio_data) <- paste0("bio", 1:19)
```

The climate variables specific to the range of the chosen species are then extracted from the wider dataset and combined with the coordinate data to create the final processed datasets on which our models will be based.

```{r Species 1 processed data}
#| echo: false
species1_biovalues <- extract(bio_data, species1_coords)[, -1] #Extracts just the climate data for the coordinates the species has been recorded at.
species1_data <- cbind(species1_coords, species1_biovalues)
write.csv(species1_data, file = here("data", "processed", "species1_data.csv"), row.names = FALSE) #Creates a csv file
```

```{r Species 2 Processed data}
#| echo: false
species2_biovalues <- extract(bio_data, species2_coords)[, -1]
species2_data <- cbind(species2_coords, species2_biovalues)
write.csv(species2_data, file = here("data", "processed", "species2_data.csv"), row.names = FALSE)

#The csv files for species1_data and species2_data can be found in the processed folder within the data folder as defined by the file structure set up in chunk 3: creating a file structure. 
```

## Distribution Modelling

#### Species 1 (Fisher)

The data downloaded from GBIF only contains data on presence, absence was not recorded. Absence data is required to run the models therefore pseudoabsence data was created by randomly generating 500 points within the study area of each species. This was done using the code below.

```{r Creating Species 1 study area extent mask}
#| echo: false

#Defining the study area extent
species1_extent <- extent(
    min(species1_coords$lon) - 5,
    max(species1_coords$lon) + 5,
    min(species1_coords$lat) - 5,
    max(species1_coords$lat) + 5
)
#The extent is defined as slightly larger than the min and max of the species coordinate data to account for uncertainties and create a buffer area.

#Creating Mask Area for species 1 study area
species1_extent_mask <- rasterize(world_map, raster(species1_extent, res=0.5))
```

```{r Species 1 psuedoabsence data}
#| code-fold: true
#| code-summary: "Generation of Pseudoabsence Data"

set.seed(123) #seed used so that the randomly generated absence points are the same each time so that analysis can be consistent. 
species1_bg <- randomPoints(species1_extent_mask, 500, ext=species1_extent) #generates the pseudoabsence points. 
colnames(species1_bg) <- c("lon", "lat") #assigns names to the columns
```

```{r Species 1 dataset with presence absence and climate variables}
#| echo: false

species1_biodata <- crop(bio_data, species1_extent)

#Combining the presence and absence points.
species1_combined_coords <- rbind(species1_coords, species1_bg)

#Creates dataframe where 1 indicates presence and 0 absence at each coordinate.
species1_pa_data <- c(rep(1, nrow(species1_coords)), rep(0, nrow(species1_bg)))

# Extract the bioclimatic data for the presence and background points
species1_env_pa_data <- data.frame(cbind(pa = species1_pa_data, extract(species1_biodata, species1_combined_coords)))

#Creating datasets for absence and presence separately for further testing of predictive power.
species1_testpres <- data.frame(extract(species1_biodata, species1_coords))
species1_testabs <- data.frame(extract(species1_biodata, species1_bg))

```

The ability of different climate variables to predict the presence absence data was then compared by creating a set of generalised linear models. The models assume binomial errors as the presence absence data is binary data. In total five models were created each containing 3-4 of the climate variables, as this number of variables per model which was small enough to prevent issues of multiple colinearity resulting in singularities and overfitting.

[Model Summaries and AIC:]{.underline}

```{r Species 1, model 1 (variables 1-4)}
#| echo: false
species1_glm1 <- glm(pa ~ bio1 + bio2 + bio3 + bio4,
    family = binomial(link = "logit"), data = species1_env_pa_data
)
```

```{r Species 1, model 2 (variables 5-8)}
#| echo: false
species1_glm2 <- glm(pa ~ bio5 + bio6 + bio7 + bio8,
    family = binomial(link = "logit"), data = species1_env_pa_data
)
```

```{r Species 1, model 3 (variables 9-12)}
#| echo: false
species1_glm3 <- glm(pa ~ bio9 + bio10 + bio11 + bio12,
    family = binomial(link = "logit"), data = species1_env_pa_data
)
```

```{r Species 1, model 4 (variables 13-16)}
#| echo: false
species1_glm4 <- glm(pa ~ bio13 + bio14 + bio15 + bio16,
    family = binomial(link = "logit"), data = species1_env_pa_data
)
```

```{r Species 1, model 5 (variables 17-19)}
#| echo: false
species1_glm5 <- glm(pa ~ bio17 + bio18 + bio19,
    family = binomial(link = "logit"), data = species1_env_pa_data
)
```

::: panel-tabset
###### Model 1

Model containing variables 1, 2, 3, and 4.

```{r Species 1 Model 1 results}
#| echo: false
summary(species1_glm1) 
```

###### Model 2

Model containing climate variables 5, 6, 7, and 8.

```{r Species 1 Model 2 results}
#| echo: false
summary(species1_glm2)
```

###### Model 3

Model containing climate variables 9, 10, 11, and 12.

```{r Species 1 Model 3 results}
#| echo: false
summary(species1_glm3)
```

###### Model 4

Model containing climate variables 13, 14, 15, and 16.

```{r Species 1 Model 4 results}
#| echo: false
summary(species1_glm4)
```

###### Model 5

Model containing climate variables 17, 18, and 19.

```{r Species 1 Model 5 results}
#| echo: false
summary(species1_glm5)
```
:::

Figure 1: Tables showing summary statistics for each generalised linear model of the effect of climate on species 1 distribution.

All models were able to somewhat predict the distribution of fishers, however variable 10 as well as all of the variables in model 2 do not appear to be as important for predicting distribution as some of the other variables.

To compare how well each model predicts the presence/absence of fishers an Akaike Information Criterion test was performed.

```{r Comparison of AIC values for species 1 models}
#| warning: false
#| echo: false
AIC(species1_glm1,species1_glm2, species1_glm3, species1_glm4, species1_glm5 )
```

Figure 2: Table comparing the AIC values of the five models for species 1.

Model 4 has the lowest AIC value and is therefore the best model for predicting fisher distribution, out of those created in this analysis and based on this set of 19 climate variables. This suggests that precipitation of the wettest and driest months, precipitation seasonality and precipitation of the wettest quarter are all very important in determining fisher distribution. The fact that model 4, which contains only variables related to precipitation, was the best model may suggest that precipitation has a stronger effect on fisher distribution than temperature. Although temperature does still appear to have an effect. 

[Evaluating AUC and correlation of models:]{.underline}

The ability of a models predictions to match the observed data can also be evaluated by looking at the area under the curve (AUC) and correlation (cor) values.

```{r Species 1 model 1 evaluation}
#| echo: false
#Evaluate function can be used to produce AUC and cor variables
species1_model1_eval <- evaluate(species1_testpres, species1_testabs, species1_glm1) 
```

```{r Species 1 model 2 evaluation}
#| echo: false
species1_model2_eval <- evaluate(species1_testpres, species1_testabs, species1_glm2)
```

```{r Species 1 model 3 evaluation}
#| echo: false
species1_model3_eval <- evaluate(species1_testpres, species1_testabs, species1_glm3)
```

```{r Species 1 model 4 evaluation}
#| echo: false
species1_model4_eval <- evaluate(species1_testpres, species1_testabs, species1_glm4)
```

```{r Species 1 model 5 evaluation}
#| echo: false
species1_model5_eval <- evaluate(species1_testpres, species1_testabs, species1_glm5)
```

::: panel-tabset
###### Model 1

Model containing variables 1, 2, 3, and 4.

```{r Species 1 Model 1 evaluation results}
#| echo: false
print(species1_model1_eval) 
```

###### Model 2

Model containing climate variables 5, 6, 7, and 8.

```{r Species 1 Model 2 evaluation results}
#| echo: false
print(species1_model2_eval) 
```

###### Model 3

Model containing climate variables 9, 10, 11, and 12.

```{r Species 1 Model 3 evaluation results}
#| echo: false
print(species1_model3_eval) 
```

###### Model 4

Model containing climate variables 13, 14, 15, and 16.

```{r Species 1 Model 4 evaluation results}
#| echo: false
print(species1_model4_eval) 
```

###### Model 5

Model containing climate variables 17, 18, and 19.

```{r Species 1 Model 5 evaluation results}
#| echo: false
print(species1_model5_eval) 
```
:::

Figure 3: Tables showing the AUC and cor values of each model for species 1.

The results of evaluating the models using AUC and cor values matched those done by comparing the model AIC values. Model 4 had both the highest AUC and the highest correlation. However its cor values was just below 0.5 suggesting that the correlation between these model predictions and the observed distributions are of moderate strength at best. Potentially a model which combines data on precipitation and temperature might have provide more accurate predictions. This could also suggest that non-climate variables are also important in determining the distribution of fishers e.g. interactions with other species.

As model 4 is consistently shown to be the best model at predicting fisher distribution (out of those created in this analysis) this is the one which will be used to map current distribution of fishers.

[Mapping current distribution:]{.underline}

```{r Predicting Species 1 current distribution}
#| echo: false
species1_pred <- predict(species1_biodata, species1_glm4, ext = species1_extent, type = "response")
species1_pred <- crop(species1_pred, species1_extent)

```

```{r Calculating Species 1 Thresholds}
#| echo: false
# To allow binary mapping of presence vs absence a threshold for presence was calculated based on the evaluation of model 4.
species1_tr <- threshold(species1_model4_eval, "prevalence")
```


```{r Plot species 1 GLM predictions}
#| echo: false
#| fig-cap: "Figure 4: Map showing predicted probabilites of species 1 occurence based on predictions from model 4."

plot(species1_pred, main = "GLM Probability of Occurence")
plot(world_map, add = TRUE, border = "lightgrey")

legend(x = -143, y = 37, strwrap("GBIF Coordinates", 15), bty = "n", pch = 21, pt.bg = c("#56cc9d", "white"),pt.lwd = 0,pt.cex = 1 ,cex = 0.75,)
points(species1_coords, col="#288660", pch=21, cex=1, bg = "#56cc9d")
```
```{r Species 1 Presence and Absence plot}
#| echo: false
#| fig-cap: "Figure 5: Map showing current predicted areas of Presence and Absence for species 1 based on model 4."
plot(species1_pred >= species1_tr, main = "Current Distribution", col = c("#56cc9d", "#F6E620"))
plot(world_map, add = TRUE, border = "lightgrey")
legend(x = -143, y = 40, c("Absent","Present"), bty = "n", pch = 22, pt.bg = c("#56cc9d", "#F6E620"),pt.lwd = 0,pt.cex = 1 ,cex = 1)

```

The distribution predicted by the model matches the observed data to a certain extent. The high probabilities of occurence found across the entire East side of North America and along the Western coast, especially moving up into Canada both line up with the two main clusters of Fisher presence shown by the GBIF data. However the model mostly misses the group of fishers which inhabit central Canada. On the Eastern coast the area's of predicted high probability also extend further south and north than observed data. As model four only includes information on precipitation it is possible adding temperature would restrict the latitudinal range predicted by the model. The binary presence absence map predicts the current distribution of fishers to be split into two distinct populations, one larger one occupying most of Eastern Canada and the US and a smaller one running along the West Coast. While these are the two main clusters seen on observed data from GBIF the actual distribution of Fishers appears to run in a continuous band across the continent. This also suggests that factors other than climate, or at least other than those in model 4, are important to consider when predicting fisher distribution.

#### Species 2 (North American Porcupine)

```{r Creating Species 2 study area extent mask}
#| echo: false

#Defining the study area extent
species2_extent <- extent(
    min(species2_coords$lon) - 5,
    max(species2_coords$lon) + 5,
    min(species2_coords$lat) - 5,
    max(species2_coords$lat) + 5
)

#Creating Mask Layer for study area
species2_extent_mask <- rasterize(world_map, raster(species2_extent, res=0.5))
```

```{r Species 2 psuedoabsence data}
#| echo: false
set.seed(99)
species2_bg <- randomPoints(species2_extent_mask, 500, ext=species2_extent) #generates the pseudoabsence points. 
colnames(species2_bg) <- c("lon", "lat") #assigns names to the columns
```

```{r Species 2 dataset with presence absence and climate variables}
#| echo: false

species2_biodata <- crop(bio_data, species2_extent)

#Combining the presence and absence points.
species2_combined_coords <- rbind(species2_coords, species2_bg)

#Creates dataframe where 1 indicates presence and 0 absence at each coordinate.
species2_pa_data <- c(rep(1, nrow(species2_coords)), rep(0, nrow(species2_bg)))

# Extract the bioclimatic data for the presence and background points
species2_env_pa_data <- data.frame(cbind(pa = species2_pa_data, extract(species2_biodata, species2_combined_coords)))

#Creating datasets for absence and presence separately for further testing of predictive power.
species2_testpres <- data.frame(extract(species2_biodata, species2_coords))
species2_testabs <- data.frame(extract(species2_biodata, species2_bg))

```


[Model Summaries and AIC:]{.underline}

```{r Species 2, model 1 (variables 1-4)}
#| echo: false
species2_glm1 <- glm(pa ~ bio1 + bio2 + bio3 + bio4,
    family = binomial(link = "logit"), data = species2_env_pa_data
)
```

```{r Species 2, model 2 (variables 5-8)}
#| echo: false
species2_glm2 <- glm(pa ~ bio5 + bio6 + bio7 + bio8,
    family = binomial(link = "logit"), data = species2_env_pa_data
)
```

```{r Species 2, model 3 (variables 9-12)}
#| echo: false
species2_glm3 <- glm(pa ~ bio9 + bio10 + bio11 + bio12,
    family = binomial(link = "logit"), data = species2_env_pa_data
)
```

```{r Species 2, model 4 (variables 13-16)}
#| echo: false
species2_glm4 <- glm(pa ~ bio13 + bio14 + bio15 + bio16,
    family = binomial(link = "logit"), data = species2_env_pa_data
)
```

```{r Species 2, model 5 (variables 17-19)}
#| echo: false
species2_glm5 <- glm(pa ~ bio17 + bio18 + bio19,
    family = binomial(link = "logit"), data = species2_env_pa_data
)
```

::: panel-tabset
###### Model 1

Model containing variables 1, 2, 3, and 4.

```{r Species 2 Model 1 results}
#| echo: false
summary(species2_glm1) 
```

###### Model 2

Model containing climate variables 5, 6, 7, and 8.

```{r Species 2 Model 2 results}
#| echo: false
summary(species2_glm2)
```

###### Model 3

Model containing climate variables 9, 10, 11, and 12.

```{r Species 2 Model 3 results}
#| echo: false
summary(species2_glm3)
```

###### Model 4

Model containing climate variables 13, 14, 15, and 16.

```{r Species 2 Model 4 results}
#| echo: false
summary(species2_glm4)
```

###### Model 5

Model containing climate variables 17, 18, and 19.

```{r Species 2 Model 5 results}
#| echo: false
summary(species2_glm5)
```
:::

Figure 6: Tables showing summary statistics for each generalised linear model of the effect of climate on species 2 distribution.

For the North American Porcupine only three of the models are able to significantly predict occurrence, models 1, 4, 5. Although the predictive power of model 4 may mostly rely on just one variable, variable 15 (precipitation seasonality). 

To compare how well each model predicts the presence/absence of the North American Porcupine an Akaike Information Criterion test was performed.

```{r Comparison of AIC values for species 2}
#| warning: false
#| echo: false
AIC(species2_glm1,species2_glm2, species2_glm3, species2_glm4, species2_glm5 )
```

Figure 7: Table comparing the AIC values of the five models for species 2.

The model with the lowest AIC value is model 1, which indicates annual mean temperature, mean diurnal range, isothermality and temperature seasonality are all important factors in determining porcupine distribution. However as the other two models containing primarily variables linked to temperature had very limited predictive ability the role. of precipitation cannot fully be discounted as both models 4 and 5 had lower AICS than models 2 and 4. In general all of the models for species 2 had higher AIC's than the models for species 1 which suggests that climate is not as important in controlling the range of porcupines as it is for fishers. 

[Evaluating AUC and correlation of models:]{.underline}

The ability of a models predictions to match the observed data can also be evaluated by looking at the area under the curve (AUC) and correlation (cor) values.

```{r Species 2 model 1 evaluation}
#| echo: false
#Evaluate function can be used to produce AUC and cor variables
species2_model1_eval <- evaluate(species2_testpres, species2_testabs, species2_glm1) 
```

```{r Species 2 model 2 evaluation}
#| echo: false
species2_model2_eval <- evaluate(species2_testpres, species2_testabs, species2_glm2)
```

```{r Species 2 model 3 evaluation}
#| echo: false
species2_model3_eval <- evaluate(species2_testpres, species2_testabs, species2_glm3)
```

```{r Species 2 model 4 evaluation}
#| echo: false
species2_model4_eval <- evaluate(species2_testpres, species2_testabs, species2_glm4)
```

```{r Species 2 model 5 evaluation}
#| echo: false
species2_model5_eval <- evaluate(species2_testpres, species2_testabs, species2_glm5)
```

::: panel-tabset
###### Model 1

Model containing variables 1, 2, 3, and 4.

```{r Species 2 Model 1 evaluation results}
#| echo: false
print(species2_model1_eval) 
```

###### Model 2

Model containing climate variables 5, 6, 7, and 8.

```{r Species 2 Model 2 evaluation results}
#| echo: false
print(species2_model2_eval) 
```

###### Model 3

Model containing climate variables 9, 10, 11, and 12.

```{r Species 2 Model 3 evaluation results}
#| echo: false
print(species2_model3_eval) 
```

###### Model 4

Model containing climate variables 13, 14, 15, and 16.

```{r Species 2 Model 4 evaluation results}
#| echo: false
print(species2_model4_eval) 
```

###### Model 5

Model containing climate variables 17, 18, and 19.

```{r Species 2 Model 5 evaluation results}
#| echo: false
print(species2_model5_eval) 
```
:::

Figure 8: Tables showing the AUC and cor values of each model for species 2.

The results of the evaluation of AUC and cor values are consistent with the AIC values of the models, with model 1 showing the highest AUC and cor values. However the correlation of model one was around 0.3. Suggesting that even though it is the best model it is still quite poor at predicting porcupine distribution. Strengthening the argument that climate is not the main factor determining the range of the North American Porcupine. As it is the best model created in this analysis at explaining

[Mapping current distribution:]{.underline}

```{r Predicting Species 2 current distribution}
#| echo: false
species2_pred <- predict(species2_biodata, species1_glm1, ext = species2_extent, type = "response")
species2_pred <- crop(species2_pred, species2_extent)

```

```{r Calculating Species 2 Thresholds}
#| echo: false
# To allow binary mapping of presence vs absence a threshold for presence was calculated based on the evaluation of model 4.
species2_tr <- threshold(species2_model1_eval, "prevalence")
```

```{r Plotting species 2 current distribution}
#| echo: false
#| fig-cap: "Figure 9: Map showing predicted probabilites of species 2 occurence based on predictions from model 1."
#| fig-align: 'center'
plot(species2_pred, main = "GLM Probability of Occurence")
plot(world_map, add = TRUE, border = "darkgrey")
points(species2_coords, col="#288660", pch=21, cex=1, bg = "#56cc9d")
legend(x = -160, y = 37, strwrap("GBIF Coordinates", 15), bty = "n", pch = 21, pt.bg = c("#56cc9d", "white"),pt.lwd = 0,pt.cex = 1 ,cex = 0.75,)
```
```{r Species 2 Presence and Absence plot}
#| echo: false
#| fig-cap: "Figure 10: Map showing current predicted areas of Presence and Absence for species 2 based on model 1."
plot(species2_pred >= species2_tr, main = "Current Distribution", col = c("#56cc9d", "#F6E620"))
plot(world_map, add = TRUE, border = "lightgrey")
legend(x = -160, y = 37, c("Absent","Present"), bty = "n", pch = 22, pt.bg = c("#56cc9d", "#F6E620"),pt.lwd = 0,pt.cex = 1 ,cex = 1)
```

In general the observed data from the GBIF dataset matches with areas predicted by the model to have a high chance of occurence. However the model slightly under estimates the latitudinal range of the porcupine with several presence coordinates falling both above and below the main region of predicted occupation. The binary presence absence map does not include the majority of the large cluster of observations found in central and western America. This model of current distribution actually significantly underestimates the range of porcupines. Similarly to the fisher data it shows two completely separate populations despite the real life observations suggesting otherwise. According to both maps we would expect the climate conditions in south-eastern America to support porcupine habitation. However very few based on the GBIF data there are very few porcupines here potentially this area is lacking other important features such as corrected habitat type or an important food plant. 

Overall the current distributions of fishers and porcupines are fairly similar, therefore we would expect a high degree of overlap. 

## Distribution Overlap

#### Plotting

Although simply from visually observing the maps of current distribution for both species it is clear they have a large degree of overlap it is still useful to plot maps of the overlap to confirm this. To create fig 11 the results of the predictions for current distribution of each species were combined into one dataset. In the original prediction models the chance the the species will occur in an area is ranked on a scale of 0-1 with higher numbers indicating a higher chance the species will be found there. By combining these datasets in a summative way it creates a dataframe where values around 1 indicate only one species is found in the area and values approaching 2 show that both species are likely to occur

```{r Combining species 1 and species 2 predicted distributions}
#| code-fold: true
#| code-summary: "Creating combined datasets code"
combined <- mosaic(species1_pred, species2_pred, fun = "sum")
```


```{r Plotting predicted probability of both species occuring between the current distributions }
#| echo: false
#| fig-cap: "Figure 11: Map showing the probability that between 0 and 1 species occur in a certain area, yellow represents high likelihood of both species occuring and therefore areas of overlap"
plot(combined, main = "Overlap of GLM Occurences")

```

The individual thresholds for presence of species 1 and 2 were added together to create a threshold above which you would expect both species to occur, therefore allowing us to predict areas of overlapping distribution. 

```{r Plot sympatric and non-sympatric areas}
#| echo: false
#| fig-cap: "Figure 12: Map showing areas of sympatry between species 1 and 2"
plot(combined >= (species1_tr + species2_tr),  main = "Current Distribution of Sympatry", col = c("#56cc9d", "#F6E620"))
plot(world_map, add = TRUE, border = "lightgrey")
legend(x = -166, y = 37, c("Non-sympatric areas","Sympatric areas"), bty = "n", pch = 22, pt.bg = c("#56cc9d", "#F6E620"),pt.lwd = 0,pt.cex = 1 ,cex = 1)
```

The majority of sympatric areas predicted by the models occur in the USA, particularly the Eastern side of it. There is also a small amount of overlap predicted reaching up along the south eastern and south western coast of Canada. 

#### Metrics

The degree of overlap can be calculated by finding the sum of predicted localities at which sympatry occurs, based on the threshold created to make fig 12, a dataset combining coordinates from both species and the spatial data mapping occurence of both species, from figure 11. This is then expressed as a proportion of the total coordinates for both species. This will allows the metric to be compared across different species pairs without being affected by the number of coordinates available for each species. See code below for how to calculate. Therefore the final metric of degree of overlap is expressed as the proportion of total coordinates for each species which are above the 2 species occurence threshold.

```{r Creating a Dataset of coordinates for both specices}
#| echo: false
combined_coords <- rbind(species1_coords, species2_coords) #combines the coordinates from each species into one datafram
```


```{r Calculating degree of overlap}
#| code-fold: true
#| code-summary: "Degree of Overlap Calculation"
overlap_localities <- extract(combined >= (species2_tr+species1_tr), combined_coords) #Extracts which localities within the combined coordinates of both species

overlap_metric <- (sum(overlap_localities == 1, na.rm = TRUE))/length(combined_coords$lon) #calculates the total sum of localities and divides them by the total number of coordinates for both species. 

```

```{r Results of overlap metric analysis}
#| echo: false
print(overlap_metric)
```

Just under 60% of localities for Fishers and North American Porcupines are expected to overlap. 


## Modelling Interspecies Distribution Dependence

To test whether there is interspecies distribution dependence of species 1 on species 2 firstly you have to calculate whether species 2 occurs at the presence and absence coordinates used for species 1. Which was done using the code below.

```{r Calculating species 2 probability of occurence at species 1 coordinates}
#| code-fold: true
#| code-summary: "Calculating presence/absence of species 2 and species 1 coordinates"

species2_occurence_at_species1<- extract(species2_pred, species1_combined_coords)
colnames(species2_occurence_at_species1) <- c("ID", "pa") #extracts the glm predicted chance of occurence for species 2 at each of the coordinates used to model species 1 presence and absence. 

species2_pa_at_species1<- data.frame(ifelse(species2_occurence_at_species1$pa > species2_tr, (paste(1)), (paste(0)))) # Converts the chances of occurrence into binary values with 0 showing absence and 1 showing presence based on the threshold for presence species2_tr calculated earlier. 
colnames(species2_pa_at_species1) <- "species2_pa" 
```


```{r Adding species 2 presence/absence to the species1_env_pa_data datset}
#| echo: false

species1_env_pa_data$species2_pa = species2_pa_at_species1$species2_pa
```

As shown in the code above the species 2 occurence values were extracted from predications made based on a model which included climate variables. Specifically variabesl 1, 2, 3 and 4 as model 1 was used to make the current distribution predictions for species 2. Therefore even when just creating a model for the regression of species 1 pa against extracted species 2 pa climate values are indirectly involved as they contributed to whether species 2 was considered present or absent at each location. However models to test whether climate variables have an interaction on the ability of species 2 to predict the presence of species 1 were also created. 

6 Models were created, a null (reduced) model, a simple linear model looking at the correlation between species 1 and 2 distributions, and four models considering the effect of various climate variables in addition to species 2 on species 1. Two different sets of climate variables were chosen and for each set a no interaction and a with interaction (full) model were created. The sets of climate variables used were variables 1, 2, 3, and 4, and variables 13, 14, 15, and 16. These were chosen as they are the variables groups known to be most important in determining the distributions of species 2 and 1 respectively. Therefore they are the most likely to impact the relationship between species 1 and 2. 

To see if there was a significant difference in the ability of models to fit the distribution of species chi-squared tests were performed. A chi-squared was used instead of an ANOVA as species distributions are binary data and therefore binomial glm's were used. Chi-squared is considered more appropriate to use on binomial models than an ANOVA. 

```{r Models}
#| echo: FALSE
#| warning: false
#glm is used for all of the models here as the lm function assumes data is normally distributed, however as this is binary data the distribution is actually binomial. glm allows you to specify what sort of distribution your data has, therefore allowing you to break the assumption of normality. 

#IF RE-RUNNING WITH NEW SPECIES CHANGE THE CLIMATE VARIABLES TO THOSE MOST APPROPRIATE FOR YOUR CHOSEN SPECIES.

#Reduced (null) Model
null_model <- glm(pa ~ 1,  family = binomial(link = "logit"), data = species1_env_pa_data)

#Effect of species 2 on species 1 distribution
no_climate_model <- glm(pa ~ species2_pa, family = binomial(link = "logit"), data = species1_env_pa_data)

# Models for climate variables 1, 2, 3, and 4
no_interaction_model1 <- glm(pa ~ species2_pa + bio1 + bio2 + bio3 + bio4, family = binomial(link = "logit"), data = species1_env_pa_data)

interaction_model1 <- glm(pa ~ species2_pa * bio1 * bio2 * bio3 * bio4, family = binomial(link = "logit"), data = species1_env_pa_data)

#Models for climate variables 13, 14, 15, and 16
no_interaction_model2 <- glm(pa ~ species2_pa + bio13 + bio14 + bio15 + bio16, family = binomial(link = "logit"), data = species1_env_pa_data)

interaction_model2 <- glm(pa ~ species2_pa * bio1 * bio2 * bio3 * bio4, family = binomial(link = "logit"), data = species1_env_pa_data)


```

```{r Comparing AICs of linear models}
#| echo: false
#| fig-cap: "Figure 13: Table comparing the AIC's of various models for the effect of species 2 and climate on species 1"
AIC(null_model, no_climate_model, no_interaction_model1, interaction_model1, no_interaction_model2, interaction_model2)
```

Based on preliminary analysis of the AIC values it appears that only including species 2 has very little effect on the fit of the model. It is only when climate variables are considered, whether as interactions or not, that the fit begins to drastically improve. This could suggest that climate has a stronger effect on fisher distribution than porcupines. 

::: panel-tabset

###### Species Effect

```{r}
#| echo: false
anova(null_model, no_climate_model, test = "Chisq")
```
###### Species vs climate 1

```{r}
#| echo: false
anova(no_climate_model, no_interaction_model2, test = "Chisq")
```
###### Species and Climate interaction 1

```{r}
#| echo: false
anova(no_interaction_model1, interaction_model1, test = "Chisq")
```
###### Species vs CLimate 2

```{r}
#| echo: false
anova(no_climate_model, no_interaction_model2, test = "Chisq")
```
###### Species and CLimate Interaction 2

```{r}
#| echo: false
anova(no_interaction_model2, interaction_model2,test = "Chisq")
```
:::

Figure 14: Tables showing the results of Chi-squared tests between pairs of models for the effect of species 2 on species 1

The statistical analyses above show that Porcupine distribution does have an affect on Fishers as the species only model did perform significantly better when compared to the null model. However both of the no-interaction climate models were significantly better at explaining Fisher distribution than the model just containing species suggesting that climate has a much larger affect on them than Porcupines. However adding climate variables as interactions also improved the fit of the model to fisher distribution, suggesting that porcupines can affect the distribution of Fishers but it is heavily mediated by climate conditions.

As these results seemed to suggest that climate is the main factor influencing fisher distribution I decided to compare whether removing species from no-interaction models actually had any significant effects. Model 4 from figure 1 is the same as the no interaction model for the second set of climate variables therefore these models were compared. 

```{r}
#| echo: false
#IGNORE IF RE-RUNNING WITH A DIFFERENT PAIR OF SPECIES, THIS IS SPECIFIC TO THE RESULTS OF MY ANALYSIS
anova(species1_glm4, no_interaction_model2, test = "Chisq")
```
Although small there was a significant effect of removing Porcupines as a variable. This indicates that there is a small amount of interspecies dependence even when climate variables are also being considered. Due to the high degree of overlap between the species calculated earlier this likely represents weak positive correlation between the two species. However as climate is by far the more influential variable does not neccessarily suggest that fishers have a dependence on porcupines to inhabit a region. It is likely this could instead reflect overlap in prefered conditions between the species. 

## Future Distribution Prediction

To predict the future distribution of species future climate projections are required to provide data to run the previously created models on. The projection data used here was from CMIP5 (Coupled Model Intercomparison Project Phase 5), which is available here <https://aims2.llnl.gov/search>.

```{r Downloading future climate projections data}
#| echo: false
#Downloading the data
future_bio_data <- cmip6_world(
    model = "CanESM5",
    var = "bio", 
    ssp = "245",
    res = 10,
    time = "2061-2080",
    path = here("data", "raw")
)
names(future_bio_data) <- names(bio_data) #ensures the same names used in bio_data are applied to the future_bio_data dataframe.
```

#### Species 1

Future climate predictions are based off model 4 as this was the best at predicting current distribution for fishers. Future predictions were calculated by running a prediction based of the original model 4 but using the new projection climate data as opposed to the current climate data. 

```{r Crop future climate data to the species 1 study area}
#| echo: false
#crops projection data so it is just looking at the region of interest.
species1_future_bio_data <- crop(future_bio_data, species1_extent)
```

```{r Predicting future distribution of species 1}
#| echo: false
species1_future_pred <- predict(species1_future_bio_data, species1_glm4, ext = species1_extent, type = "response")
```

```{r Plotting future distributions for species 1}
#| echo: false
#| fig-cap: "Figure 13: Maps comparing the Present GLM Occurences and Distributions of Species 1 with those based on Climate Projections for 2060-2081"

# Plots results side by side
par(mfrow = c(2, 2))

# Present distribution
plot(species1_pred, main = "Present GLM Probability of Occurence")
plot(world_map, add = TRUE, border = "darkgrey")

# Future distribution
plot(species1_future_pred, main = "Future GLM Probability of Occurence")
plot(world_map, add = TRUE, border = "darkgrey")

#Current Presence
plot(species1_pred >= species1_tr, main = "Present Distribution", col = c("#56cc9d", "#F6E620"))
plot(world_map, add = TRUE, border = "lightgrey")
legend(x = -140, y = 45, c("Absent","Present"), bty = "n", pch = 22, pt.bg = c("#56cc9d", "#F6E620"),pt.lwd = 0,pt.cex = 1 ,cex = 0.50)

#Future presence
plot(species1_future_pred >= species1_tr, main = "Future Distribution", col = c("#56cc9d", "#F6E620"))
plot(world_map, add = TRUE, border = "lightgrey")
legend(x = -140, y = 45, c("Absent","Present"), bty = "n", pch = 22, pt.bg = c("#56cc9d", "#F6E620"),pt.lwd = 0,pt.cex = 1 ,cex = 0.50)
```
There is very little, if any change in the future distribution of fishers linked to climate change based on these models. There is a slight loss of connectivity within the western population. On the other hand the Eastern population shows a slight range expansion northwards into Quebec. Overall fishers are predicted by these models to be able to retain most of their current distribution, with potential for a small range expansion northwards in certain areas. 

```{r Calculating changes in range for species 1}
#| echo: false
species1_localities <- extract(species1_pred >= species1_tr, species1_coords)[, -1]
species1_current_range <- sum(species1_localities)

species1_future_localities <- extract(species1_future_pred >= species1_tr, species1_coords)[, -1]
species1_future_range <- sum(species1_future_localities, na.rm = TRUE)

species1_range_expansion <- sum((species1_localities == 0) & (species1_future_localities == 1), na.rm = TRUE)
species1_range_contraction <- sum((species1_localities == 1) & (species1_future_localities == 0), na.rm = TRUE)

```

```{r Printing species 1 range results}
#| echo: false
print("Range change metrics:")
print(paste("Current suitable localities:", species1_current_range))
print(paste("Future suitable localities:", species1_future_range))
print(paste("Number of new suitable localities (expansion):", species1_range_expansion))
print(paste("Number of lost suitable localities (contraction):", species1_range_contraction))
```

As predicted from looking at the maps of distribution changes there is very little difference in the current and future predicted range of fishers. The species undergoes both range expansions and contractions, with very small net contraction of range expected in the future. 

#### Species 2

Future climate predictions are based off model 1 as this was the best at predicting current distribution for Porcupines. Future predictions were calculated in the same way as for species 1. 

```{r Crop future climate data to the species 2 study area}
#| echo: false
#crops projection data so it is just looking at the region of interest.
species2_future_bio_data <- crop(future_bio_data, species2_extent)
```

```{r Predicting future distribution of species 2}
#| echo: false
species2_future_pred <- predict(species2_future_bio_data, species2_glm1, ext = species2_extent, type = "response")
```



```{r Plotting future distributions of species 2}
#| echo: false
#| fig-cap: "Figure 14: Maps comparing the present GLM Occurences and Distributions of Species 2 with those based on Climate Projections for 2060-2081"

par(mfrow = c(2,2))

# Present distribution
plot(species2_pred, main = "Present GLM Occurence")
plot(world_map, add = TRUE, border = "darkgrey")

# Future distribution
plot(species2_future_pred, main = "Future GLM Occurence")
plot(world_map, add = TRUE, border = "darkgrey")

plot(species2_pred >= species2_tr, main = "Current Distribution", col = c("#56cc9d", "#F6E620"))
plot(world_map, add = TRUE, border = "lightgrey")
legend(x = -160, y = 45, c("Absent","Present"), bty = "n", pch = 22, pt.bg = c("#56cc9d", "#F6E620"),pt.lwd = 0,pt.cex = 1 ,cex = 0.75)

plot(species2_future_pred >= species2_tr, main = "Future Distribution", col = c("#56cc9d", "#F6E620"))
plot(world_map, add = TRUE, border = "lightgrey")
legend(x = -160, y = 45, c("Absent","Present"), bty = "n", pch = 22, pt.bg = c("#56cc9d", "#F6E620"),pt.lwd = 0,pt.cex = 1 ,cex = 0.75)
```
The range of North American Porcupines is expected in increase significantly, with large expansions both North and South of the current range. Based on climate data alone is appears that climate change could allow porcupines to colonise all of the United States as well as most regions of Canada except the centre. However this increase in range would include a shift in habitat from grasslands and temperate forest towards boreal forests and tundra in the North and tropical forests in the South (NABCI, 2016). Therefore in reality if climate changes are not accompanied by an expansion of the preferred habitat of porcupines then they might not be able to fully track the climate changes, limiting the observed range expansion. However similar to the fishers these results suggest that under current predictions of climate change porcupines would be expected to at a minimum maintain their current distribution. 

```{r Calculating changes in range for species 2}
#| echo: false
species2_localities <- extract(species2_pred >= species2_tr, species2_coords)[, -1]
species2_current_range <- sum(species2_localities, na.rm = TRUE)

species2_future_localities <- extract(species2_future_pred >= species2_tr, species2_coords)[, -1]
species2_future_range <- sum(species2_future_localities, na.rm = TRUE)

species2_range_expansion <- sum((species2_localities == 0) & (species2_future_localities == 1), na.rm = TRUE)
species2_range_contraction <- sum((species2_localities == 1) & (species2_future_localities == 0), na.rm = TRUE)

```

```{r Printing species 2 range results}
print("Range change metrics:")
print(paste("Current suitable localities:", species2_current_range))
print(paste("Future suitable localities:", species2_future_range))
print(paste("Number of new suitable localities (expansion):", species2_range_expansion))
print(paste("Number of lost suitable localities (contraction):", species2_range_contraction))
```
As shown by the maps in fig 14 there is a large increase in predicted distribution of the North American Porcupine, 

#### Degree of Overlap

As the range of each individual species shifts the degree of overlap between the two species is also expected to change. 

```{r Combining future predictions of species distribution}
#| echo: false
combined_future <- mosaic(species1_future_pred, species2_future_pred, fun = "sum")
```


```{r Plotting future degree of overlap}
#| echo: false
#| fig-cap: "Figure 15: Maps comparing the present GLM Occurence overlap and Distributions of Overlap  with those based on Climate Projections for 2060-2081"

par(mfrow = c(2,2))

# Present overlap
plot(combined, main = "Present overlap of GLM Occurence")
plot(world_map, add = TRUE, border = "darkgrey")

# Future overlap
plot(combined_future, main = "Future overlap of GLM Occurence")
plot(world_map, add = TRUE, border = "darkgrey")

#Current Sympatry
plot(combined >= (species1_tr + species2_tr),  main = "Current Distribution of Sympatry", col = c("#56cc9d", "#F6E620"))
plot(world_map, add = TRUE, border = "lightgrey")
legend(x = -166, y = 45, c("Non-sympatric","Sympatric"), bty = "n", pch = 22, pt.bg = c("#56cc9d", "#F6E620"),pt.lwd = 0,pt.cex = 1 ,cex = 0.7)

#Future Sympatry
plot(combined_future >= (species2_tr + species1_tr), main = "Future Distribution of Sympatry", col = c("#56cc9d", "#F6E620"))
plot(world_map, add = TRUE, border = "lightgrey")
legend(x = -166, y = 45, c("Non-Sympatric","Sympatric"), bty = "n", pch = 22, pt.bg = c("#56cc9d", "#F6E620"),pt.lwd = 0,pt.cex = 1 ,cex = 0.70)

```
The maps above show that the overlap in distribution between Fishers and North American Porcupines is expected to increase in the future. In particular sympatric area's in the future are expected to expand up the East coast of Canada, where currently they are mostly confined to the US. There are also expected to gain some new areas of overlap in the mid-western US. This increase in overlap is probably mostly due to the expansion of porcupines northward into Canada and their predicted future colonisation of the entire US as fishers have very little change in distribution between the present and future conditions. The GLM Occurence models as show that as well as the area in which they overlap increasing the general probability that both species co-occur across the region also increases. 

```{r Calculating degree of future overlap}
#| echo: false
future_overlap_localities <- extract(combined_future > (species2_tr+species1_tr), combined_coords)

future_overlap_metric <- (sum(future_overlap_localities == 1, na.rm = TRUE))/length(combined_coords$lon)

```

```{r Results of future overlap metric analysis}
#| echo: false
print(future_overlap_metric)
```
In the future the degree of overlap is predicted to be around 66% which is large than the metric calculated for current distributions. This matches with the maps of how areas of sympatry will change seen in fig 15, which also predict an increase in the amount of locations where the two species overlap. 

## Bibliography










